<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="paper-sandbox-method.html">
<link rel="import" href="paper-sandbox-object.html">
<link rel="import" href="mixins/sandbox.html">

<dom-module id="paper-sandbox">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
      }
      .section {
        @apply --layout-vertical;
      }
      .section:last-of-type {
        min-height: 100%;
      }
      .section {
        background: var(--paper-grey-50);
      }
      .type-header {
        @apply --paper-font-subhead;
        position: sticky;
        top: 0;
        background: inherit;
        height: 64px;
        padding: 0 64px 0 38px;
        line-height: 64px;
        vertical-align: middle;
        z-index: 1;
        @apply --shadow-transition;
      }
      .type-header:before {
        display: block;
        content: '';
        height: 1px;
        position: absolute;
        /* Makes the divider disapear when the toolbar is at the top of the screen */
        top: -1px;
        /* Lets a space for the icon button */
        right: 64px;
        left: 0;
        background: var(--paper-grey-200);
      }
      .type-header.elevated {
        @apply --shadow-elevation-2dp;
      }
      .booleans {
        @apply --layout-flex;
        @apply --layout-vertical;
      }
      paper-sandbox-method {
        margin: 12px;
        min-width: 200px;
        height: 40px;
      }
      .booleans paper-checkbox {
        padding: 8px 12px;
      }
      .strings {
        @apply --layout-vertical;
        @apply --layout-flex;
      }
      .numbers {
        @apply --layout-vertical;
        @apply --layout-flex;
      }
      paper-input {
        padding: 0 12px;
      }
      #moreBtn {
        display: block;
        position: sticky;
        top: 12px;
        margin-left: calc(100% - 50px);
        z-index: 2;
        margin-top: -40px;
      }
      .list {
        padding: 24px 74px 42px 24px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }
      paper-sandbox-object {
        margin: 16px;
        z-index: 0;
      }
    </style>

    <paper-icon-button id="moreBtn" icon="more-vert"></paper-icon-button>

    <template is="dom-if" if="[[descriptor.properties.boolean.length]]">
      <div class="section booleans">
        <div class="type-header">Boolean properties</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.properties.boolean}}"
              filter="[[filterFn]]">
            <paper-checkbox checked="{{item.value}}">
              [[_toHyphenate(item.name)]]
            </paper-checkbox>
          </template>
        </div>
      </div>
    </template>

    <template is="dom-if" if="[[descriptor.properties.string.length]]">
      <div class="section strings">
        <div class="type-header">String properties</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.properties.string}}"
              filter="[[filterFn]]">
            <paper-input
                label="[[_toHyphenate(item.name)]]"
                value="{{item.value}}">
            </paper-input>
          </template>
        </div>
      </div>
    </template>

    <template is="dom-if" if="[[descriptor.properties.number.length]]">
      <div class="section numbers">
        <div class="type-header">Number properties</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.properties.number}}"
              filter="[[filterFn]]">
            <paper-input
                type="number"
                label="[[_toHyphenate(item.name)]]"
                value="{{item.value}}">
            </paper-input>
          </template>
        </div>
      </div>
    </template>

    <template is="dom-if" if="[[descriptor.properties.object.length]]">
      <div class="section object">
        <div class="type-header">Object properties</div>
        <div class="list">
          <template is="dom-repeat"
              items="{{descriptor.properties.object}}"
              filter="[[filterFn]]">
            <paper-sandbox-object
                label="[[_toHyphenate(item.name)]]"
                default-value="[[item.defaultValue]]"
                value="{{item.value}}">
            </paper-sandbox-object>
          </template>
        </div>
      </div>
    </template>

    <template is="dom-if" if="[[descriptor.properties.object.length]]">
      <div class="section array">
        <div class="type-header">Array properties</div>
        <div class="list">
          <template is="dom-repeat"
              items="{{descriptor.properties.array}}"
              filter="[[filterFn]]">
            <paper-sandbox-object
                label="[[_toHyphenate(item.name)]]"
                default-value="[[item.defaultValue]]"
                value="{{item.value}}">
            </paper-sandbox-object>
          </template>
        </div>
      </div>
    </template>
    
    <template is="dom-if" if="[[descriptor.methods.length]]">
      <div class="section methods">
        <div class="type-header">Methods</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.methods}}"
              filter="[[filterFn]]">
            <paper-sandbox-method
                name="[[item.name]]"
                description="[[item.description]]"
                params="{{item.params}}"
                on-method-triggered="_methodTriggeredHandler">
            </paper-sandbox-method>
          </template>
        </div>
      </div>
    </template>

  </template>

  <script>
    /**
     * 
     * 
     * @customElement
     * @polymer
     * @apply Zecat.Sandbox
     */
    class PaperSandbox extends Zecat.Sandbox(Polymer.Element) {

      static get is() { return 'paper-sandbox'; }

      static get properties() {
        return {
          showPrivate: {
            type: Boolean,
            value: false
          },
          filterFn: {
            type: Function,
            computed: '_computeFilterFn(showPrivate)'
          }
        };
      }

      constructor() {
        super();

        Polymer.RenderStatus.afterNextRender(this, () => {
          const callback = ({[0]: entry}) => {
            entry.target.classList.toggle('elevated', entry.isIntersecting);
          };
          const targets = this.shadowRoot.querySelectorAll('.section');
          for (let target of targets) {
            const toolbar = target.querySelector('.type-header');
            (new IntersectionObserver(
              callback, {root: target, rootMargin: `-${toolbar.clientHeight+2}px 0px 0px 0px`})
            ).observe(toolbar);
          }
        });
      }

      _stopEventPropagation(e) {console.log(e);
        e.stopPropagation();
        e.stopImmediatePropagation();
      }

      _uppercaseToSpace(value) {
        return value.replace( /([A-Z])/g, " $1" );
      }

      _toHyphenate(value) {
        return value.replace( /([A-Z])/g, "-$1" ).toLowerCase();
      }

      _computeFilterFn(showPrivate) {
        return item => showPrivate || item.privacy != 'protected';
      }

      _methodTriggeredHandler(e) {
        const {model} = e, {item: {name, params}} = model;
        model.set('item.lastResponse', this.analyzedElement[name](...params.map(p => p.value)));
      }
    }

    window.customElements.define(PaperSandbox.is, PaperSandbox);

  </script>
</dom-module>
