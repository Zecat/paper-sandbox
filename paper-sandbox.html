<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="paper-sandbox-method.html">
<link rel="import" href="paper-sandbox-object.html">
<link rel="import" href="mixins/sandbox.html">

<dom-module id="paper-sandbox">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
      }
      .section {
        @apply --layout-vertical;
      }
      .section:last-of-type {
        min-height: 100%;
      }
      .section {
        background: var(--paper-grey-50);
      }
      .group-header {
        @apply --paper-font-subhead;
        position: sticky;
        top: 0;
        background: inherit;
        height: 64px;
        padding: 0 64px 0 38px;
        line-height: 64px;
        vertical-align: middle;
        z-index: 1;
        @apply --shadow-transition;
      }
      .group-header:before {
        display: block;
        content: '';
        height: 1px;
        position: absolute;
        /* Makes the divider disapear when the toolbar is at the top of the screen */
        top: -1px;
        /* Lets a space for the icon button */
        right: 64px;
        left: 0;
        background: var(--paper-grey-200);
      }
      .group-header.elevated {
        @apply --shadow-elevation-2dp;
      }
      .booleans {
        @apply --layout-flex;
        @apply --layout-vertical;
      }
      paper-sandbox-method {
        margin: 12px;
        min-width: 200px;
        height: 40px;
      }
      .booleans paper-checkbox {
        padding: 8px 12px;
      }
      .strings {
        @apply --layout-vertical;
        @apply --layout-flex;
      }
      .numbers {
        @apply --layout-vertical;
        @apply --layout-flex;
      }
      paper-input {
        padding: 0 12px;
      }
      #moreBtn {
        display: block;
        position: sticky;
        top: 12px;
        margin-left: calc(100% - 50px);
        z-index: 2;
        margin-top: -40px;
      }
      .list {
        padding: 24px 74px 42px 24px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }
      .array > .list,
      .object > .list,
      .generic > .list,
      .methods > .list {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }
      paper-sandbox-object {
        margin: 16px;
        z-index: 0;
      }
    </style>

    <paper-icon-button id="moreBtn" icon="more-vert"></paper-icon-button>

    <template
        is="dom-if"
        if="[[_shoudDisplayProperty(descriptor.count.boolean, showPrivate, showInherited)]]">
      <div class="section booleans">
        <div class="group-header">Boolean properties</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.properties.boolean}}"
              filter="[[filterFn]]">
            <paper-checkbox checked="{{item.value}}">
              [[_toHyphenate(item.name)]]
            </paper-checkbox>
          </template>
        </div>
      </div>
    </template>

    <template
        is="dom-if"
        if="[[_shoudDisplayProperty(descriptor.count.string, showPrivate, showInherited)]]">
      <div class="section strings">
        <div class="group-header">String properties</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.properties.string}}"
              filter="[[filterFn]]">
            <paper-input
                label="[[_toHyphenate(item.name)]]"
                value="{{item.value}}">
            </paper-input>
          </template>
        </div>
      </div>
    </template>

    <template
        is="dom-if"
        if="[[_shoudDisplayProperty(descriptor.count.number, showPrivate, showInherited)]]">
      <div class="section numbers">
        <div class="group-header">Number properties</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.properties.number}}"
              filter="[[filterFn]]">
            <paper-input
                type="number"
                label="[[_toHyphenate(item.name)]]"
                value="{{item.value}}">
            </paper-input>
          </template>
        </div>
      </div>
    </template>

    <template
        is="dom-if"
        if="[[_shoudDisplayProperty(descriptor.count.date, showPrivate, showInherited)]]">
      <div class="section dates">
        <div class="group-header">Date properties</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.properties.date}}"
              filter="[[filterFn]]">
            <paper-input
                type="date"
                label="[[_toHyphenate(item.name)]]"
                value="{{item.value}}">
            </paper-input>
          </template>
        </div>
      </div>
    </template>

    <template
        is="dom-if"
        if="[[_shoudDisplayProperty(descriptor.count.object, showPrivate, showInherited)]]">
      <div class="section object">
        <div class="group-header">Object properties</div>
        <div class="list">
          <template is="dom-repeat"
              items="{{descriptor.properties.object}}"
              filter="[[filterFn]]">
            <paper-sandbox-object
                label="[[_toHyphenate(item.name)]]"
                default-value="[[item.defaultValue]]"
                value="{{item.value}}">
            </paper-sandbox-object>
          </template>
        </div>
      </div>
    </template>

    <template
        is="dom-if"
        if="[[_shoudDisplayProperty(descriptor.count.array, showPrivate, showInherited)]]">
      <div class="section array">
        <div class="group-header">Array properties</div>
        <div class="list">
          <template is="dom-repeat"
              items="{{descriptor.properties.array}}"
              filter="[[filterFn]]">
            <paper-sandbox-object
                label="[[_toHyphenate(item.name)]]"
                default-value="[[item.defaultValue]]"
                value="{{item.value}}">
            </paper-sandbox-object>
          </template>
        </div>
      </div>
    </template>

    <template
        is="dom-if"
        if="[[_shoudDisplayProperty(descriptor.count.generic, showPrivate, showInherited)]]">
      <div class="section generic">
        <div class="group-header">Generic properties</div>
        <div class="list">
          <template is="dom-repeat"
              items="{{descriptor.properties.generic}}"
              filter="[[filterFn]]">
            <paper-sandbox-object
                label="[[_toHyphenate(item.name)]] [[item.type]]"
                default-value="[[item.defaultValue]]"
                value="{{item.value}}">
            </paper-sandbox-object>
          </template>
        </div>
      </div>
    </template>

    <template
        is="dom-if"
        if="[[descriptor.count.nonInheritedMethods]]">
      <div class="section methods">
        <div class="group-header">Methods</div>
        <div class="list">
          <template
              is="dom-repeat"
              items="{{descriptor.methods}}"
              filter="[[filterFn]]">
            <paper-sandbox-method
                name="[[item.name]]"
                description="[[item.description]]"
                params="{{item.params}}"
                on-method-triggered="_methodTriggeredHandler">
            </paper-sandbox-method>
          </template>
        </div>
      </div>
    </template>

  </template>

  <script>
    /**
     *
     *
     * @customElement
     * @polymer
     * @appliesMixin Zecat.Sandbox
     */
    class PaperSandbox extends Zecat.Sandbox(Polymer.Element) {

      static get is() { return 'paper-sandbox'; }

      static get properties() {
        return {
          showPrivate: {
            type: Boolean,
            value: false
          },
          showInherited: {
            type: Boolean,
            value: false
          },
          filterFn: {
            type: Function,
            computed: '_computeFilterFn(showPrivate, showInherited)'
          }
        };
      }

      constructor() {
        super();
        this._setUpDynamicShadows();
      }

      _setUpDynamicShadows() {
        const callback = ({[0]: entry}) => {
          entry.target.classList.toggle('elevated', entry.isIntersecting);
        };

        this.addEventListener('dom-change', (e) => {
          const rootTarget = event.composedPath()[0];

          if (rootTarget.parentNode !== this.shadowRoot
              || rootTarget.localName !== 'dom-if') {
            return;
          }
          // Here, the dom-change event has been dispatched
          // by a dom-if in the shadow root of this element

          // TODO: ensure an intersectionObserver doesn't already exist for
          // this section

          const section = rootTarget.previousElementSibling;
          const toolbar = section.querySelector('.group-header');
          const options = {
              root: section,
              rootMargin: `-${toolbar.clientHeight+2}px 0px 0px 0px`
          };
          const observer = new IntersectionObserver(callback, options);
          observer.observe(toolbar);
        });
      }

      _shoudDisplayProperty(count, showPrivate, showInherited) {
        if (count == undefined || showPrivate == undefined || showInherited == undefined) return;

        return showPrivate ?
                (showInherited ? count.total : count.notInherited) :
                (showInherited ? count.publicInherited : count.publicNotInherited);
      }

      _stopEventPropagation(e) {console.log(e);
        e.stopPropagation();
        e.stopImmediatePropagation();
      }

      _uppercaseToSpace(value) {
        return value.replace( /([A-Z])/g, " $1" );
      }

      _toHyphenate(value) {
        return value.replace( /([A-Z])/g, "-$1" ).toLowerCase();
      }

      _computeFilterFn(showPrivate, showInherited) {
        return item => (showPrivate || item.privacy === 'public') &&
                       (showInherited || item.inheritedFrom === undefined);
      }

      _methodTriggeredHandler(e) {
        const {model} = e, {item: {name, params}} = model;
        model.set('item.lastResponse', this.analyzedElement[name](...params.map(p => p.value)));
      }
    }

    window.customElements.define(PaperSandbox.is, PaperSandbox);

  </script>
</dom-module>
