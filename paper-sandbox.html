<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-number-input/paper-number-input.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="paper-sandbox-method.html">
<link rel="import" href="paper-sandbox-object.html">
<link rel="import" href="mixins/sandbox.html">
<link rel="import" href="paper-sandbox-icons.html">

<dom-module id="paper-sandbox">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        position: relative;
      }
      .section {
        @apply --layout-vertical;
      }
      .section:last-of-type {
        min-height: 100%;
      }
      .section {
        background: var(--paper-grey-50);
      }
      .group-header {
        @apply --paper-font-subhead;
        position: sticky;
        top: 0;
        background: inherit;
        height: 64px;
        padding: 0 64px 0 38px;
        line-height: 64px;
        vertical-align: middle;
        z-index: 1;
        @apply --shadow-transition;
      }
      .group-header:before {
        display: block;
        content: '';
        height: 1px;
        position: absolute;
        /* Makes the divider disapear when the toolbar is at the top of the screen */
        top: -1px;
        /* Lets a space for the icon button */
        right: 64px;
        left: 0;
        background: var(--paper-grey-200);
      }
      .group-header.elevated {
        @apply --shadow-elevation-2dp;
      }
      .list paper-sandbox-method {
        margin: 12px;
        min-width: 200px;
        height: 40px;
      }
      .list paper-checkbox {
        padding: 8px 12px;
      }
      .list paper-input,
      .list paper-number-input {
        padding: 0 12px;
      }
      .list paper-sandbox-object {
        margin: 16px;
        z-index: 0;
      }
      #moreBtn {
        display: block;
        position: sticky;
        top: 12px;
        margin-left: calc(100% - 50px);
        z-index: 2;
        margin-top: -40px;
      }
      .list {
        padding: 24px 74px 42px 24px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }
      .array > .list,
      .object > .list,
      .generic > .list,
      .method > .list {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      }
    </style>

    <paper-icon-button id="moreBtn" icon="more-vert"></paper-icon-button>

    <template is="dom-repeat"
        items="{{elementEntities}}"
        as="group"
        filter="[[_groupFilter]]"
        on-dom-change="_handleDomChange">
      <div class$="section [[group.name]]">
        <div class="group-header">[[group.title]]</div>
        <div class="list">
          <dom-repeat items="{{group.items}}" filter="[[_itemFilter]]"></dom-repeat>
        </div>
      </div>
    </template>

  </template>

  <script>
    /**
     *
     *
     * @customElement
     * @polymer
     * @appliesMixin Zecat.Sandbox
     */
    class PaperSandbox extends Zecat.Sandbox(Polymer.Element) {

      static get is() { return 'paper-sandbox'; }

      static get properties() {
        return {
          showPrivate: {
            type: Boolean,
            value: false
          },
          showInherited: {
            type: Boolean,
            value: false
          },
          _itemFilter: {
            type: Function,
            computed: '_compute_itemFilter(showPrivate, showInherited)'
          },
          _groupFilter: {
            type: Function,
            computed: '_compute_groupFilter(_itemFilter)'
          }
        };
      }

      constructor() {
        super();
        this.addEventListener('method-triggered', this._methodTriggeredHandler.bind(this));
        this.groupsTemplate = {
          boolean: `<paper-checkbox checked="{{item.value}}">
                        [[item.hyphenatedName]]
                    </paper-checkbox>`,

          string: `<paper-input type="number" label="[[item.hyphenatedName]]"
                      value="{{item.value}}">
                  </paper-input>`,

          number: `<paper-number-input
                      label="[[item.hyphenatedName]]"
                      value="{{item.value}}"
                      step="0.1">
                  </paper-number-input>`,

          date: `<paper-input
                    label="[[item.hyphenatedName]]"
                    value="{{item.value}}">
                </paper-input>`,

          array: `<paper-sandbox-object
                      label="[[item.hyphenatedName]]"
                      default-value="[[item.defaultValue]]"
                      value="{{item.value}}">
                  </paper-sandbox-object>`,

          object: `<paper-sandbox-object
                      label="[[item.hyphenatedName]]"
                      default-value="[[item.defaultValue]]"
                      value="{{item.value}}">
                  </paper-sandbox-object>`,

          generic: `<paper-sandbox-object
                        label="[[item.hyphenatedName]]"
                        default-value="[[item.defaultValue]]"
                        value="{{item.value}}"
                        type="[[item.type]]">
                    </paper-sandbox-object>`,

          method: `<paper-sandbox-method
                      name="[[item.name]]"
                      description="[[item.description]]"
                      params="{{item.params}}">
                  </paper-sandbox-method>`
        };
      }

      _compute_groupFilter(_itemFilter) {
        return group => group.items.find(_itemFilter);
      }

      _getInputTemplate(groupName) {
        const template = document.createElement('template');
        template.innerHTML = this.groupsTemplate[groupName];
        return template;
      }

      _handleDomChange(e) {
        const rootTarget = e.composedPath()[0];

        if (rootTarget.parentNode !== this.shadowRoot ||
            rootTarget.localName !== 'dom-repeat' ||
            !this.elementEntities.length) {
          return;
        }

        const callback = ({[0]: entry}) => {
          entry.target.classList.toggle('elevated', entry.isIntersecting);
        };
        
        for (let section of this.shadowRoot.querySelectorAll('.section')) {
          const group = rootTarget.modelForElement(section).group;
          const domRepeat = section.querySelector('dom-repeat');
          domRepeat.appendChild(this._getInputTemplate(group.name));

          const toolbar = section.querySelector('.group-header');
          const options = {
              root: section,
              rootMargin: `-${toolbar.clientHeight+2}px 0px 0px 0px`
          };
          const observer = new IntersectionObserver(callback, options);
          observer.observe(toolbar);
        }
      }

      _compute_itemFilter(showPrivate, showInherited) {
        return item => (showPrivate || item.privacy === 'public') &&
                       (showInherited || item.inheritedFrom === undefined);
      }

      _methodTriggeredHandler(e) {
        const {name, params} = e.detail;
        e.composedPath()[0].lastResponse = this.analyzedElement[name](...params.map(p => p.value));
      }
    }

    window.customElements.define(PaperSandbox.is, PaperSandbox);

  </script>
</dom-module>
