<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="sandbox-analyzer.html">
<link rel="import" href="sandbox-configuration.html">

<!--
`paper-sandbox`


@demo demo/index.html
-->

<dom-module id="paper-sandbox">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <sandbox-analyzer
      element-properties="{{elementProperties}}"
      element-href="[[elementHref]]"
      element="[[element]]"
    ></sandbox-analyzer>

    <slot></slot>

    <sandbox-configuration
      element="[[element]]"
      element-properties="{{elementProperties}}"
      show-private="{{showPrivate}}"
    ></sandbox-configuration>

  </template>

  <script>
    Polymer({

      is: 'paper-sandbox',

      properties: {
        showPrivate: {
          type: Boolean,
          value: false
        },
        element: {
          type: Object
        },
        elementProperties: {
          type: Object
        },
        ignoredFunctions: {
          type: Array,
          value: () => ['attached', 'registered', 'ready' ,'detached']
        },
        elementHref: {
          type: String,
          notify: true,
          value: ''
        },
      },

      observers: [
        '_updateElementAttribute(elementProperties.*, element)',
        '_elementPropertiesChanged(elementProperties)',
        '_updateHref(element, elementHref)',
      ],

      _updateHref(element, elementHref) {
        if (!elementHref && element) {
          this.elementHref = `${element.importPath}${element.is}.html`;
        }
      },


      _updateElementAttribute(cr, element) {
        var nameSubpath = cr.path.indexOf('.value');
        if (nameSubpath >= 0) {
          let type = cr.path.split('.')[1];
          var itempath = cr.path.substring(0, nameSubpath);
          var item = this.get(itempath);
          var index = cr.base[type].indexOf(item);
          this.serializeValueToAttribute(item.value, item.name, element);
        }
      },

      _elementPropertiesChanged(elementProperties) {
        for (let type in elementProperties) {
          elementProperties[type].forEach((property, index) => {
            this.element.addEventListener(`${property.name}-changed`, ev => {
              this.set(`elementProperties.${type}.${index}.value`, ev.detail.value);
            });
          });
        }
      },

      attached() {
        this._observer = Polymer.dom(this).observeNodes(this._onNodesChange);
      },

      _onNodesChange: function(info) {console.log(Polymer.dom(this).children)
        this.element = Polymer.dom(this).children[0];
      },

    });
  </script>
</dom-module>
