<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="element-sandboxer.html">
<link rel="import" href="paper-properties-configuration.html">

<!--
`paper-sandbox`


@demo demo/index.html
-->

<dom-module id="paper-sandbox">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <element-sandboxer element-properties="{{elementProperties}}" element="[[element]]"></element-sandboxer>

    <div id="elementWrapper">
      <slot></slot>
    </div>

    <paper-properties-configuration
      element="[[element]]"
      element-properties="{{elementProperties}}"
      show-private="{{showPrivate}}"
    ></paper-properties-configuration>

  </template>

  <script>
    Polymer({

      is: 'paper-sandbox',

      properties: {
        showPrivate: {
          type: Boolean,
          value: false
        },
        element: {
          type: Object
        },
        elementProperties: {
          type: Object
        },
        ignoredFunctions: {
          type: Array,
          value: () => ['attached', 'registered', 'ready' ,'detached']
        }
      },

      observers: [
        '_updateElementAttribute(elementProperties.*, element)',
        '_elementChanged(element)',
        '_elementPropertiesChanged(elementProperties)'
      ],

      _updateElementAttribute(cr, element) {
        var nameSubpath = cr.path.indexOf('.value');
        if (nameSubpath >= 0) {
          let type = cr.path.split('.')[1];
          var itempath = cr.path.substring(0, nameSubpath);
          var item = this.get(itempath);
          var index = cr.base[type].indexOf(item);
          this.serializeValueToAttribute(item.value, item.name, element);
        }
      },

      _elementPropertiesChanged(newValue, oldValue) {
        for (let type in newValue) {
          newValue[type].forEach((property, index) => {
            this.element.addEventListener(`${property.name}-changed`, ev => {
              this.set(`elementProperties.${type}.${index}.value`, ev.detail.value);
            });
          });
        }
      },

      attached() {
        this._observer = Polymer.dom(this).observeNodes(this._onNodesChange);
      },

      _onNodesChange: function(info) {
        this.element = Polymer.dom(this).children[0];
      },

    });
  </script>
</dom-module>
