<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../hydrolysis/hydrolysis-analyzer.html">

<!--
`paper-sandbox`


@demo demo/index.html
-->

<dom-module id="paper-sandbox">
  <template>
    <style>
      :host {
        display: block;
      }
      #bindedProps {
        @apply --layout-horizontal;
      }
      .vertical {
        @apply --layout-vertical;
      }
    </style>
    <hydrolysis-analyzer id="analyzer" clean analyzer="{{_hydroDesc}}" loading="{{_hydroLoading}}"></hydrolysis-analyzer>
    <div id="element">
      <slot></slot>
    </div>
    <paper-toggle-button checked="{{showPrivate}}">Show private</paper-toggle-button>
    <!-- TODO: give the tooltips a better style using prism-hightlighter -->
    <div id="bindedProps">
      <div>
        <template
          is="dom-repeat"
          items="{{elementProperties.Function}}"
          filter="[[filterFn]]"
        >
          <paper-item>
          <span>[[item.name]]<paper-tooltip>[[item.desc]]</paper-tooltip></span>
          <span>
            (
            <paper-icon-button icon="settings">
            </paper-icon-button>
            )
            <paper-tooltip>
              <template
                is="dom-repeat"
                items="[[item.params]]" as="param">
                [[param.desc]]<br>
                [[param.name]]<br>
                [[param.type]]
              </template>
            </paper-tooltip>
          </span>
          <!-- TODO: Use a dropdown to display the response -->
          <paper-icon-button on-tap="_handleFunctionButtonTap" icon="send"></paper-icon-button>[[item.lastResponse]]
          <paper-item>
        </template>
      </div>
      <div class="vertical">
        <template
          is="dom-repeat"
          items="{{elementProperties.Boolean}}"
          filter="[[filterFn]]"
        >
          <paper-item>
            <paper-checkbox checked="{{item.value}}">[[item.name]]</paper-checkbox>
            <paper-tooltip>[[item.desc]]</paper-tooltip>
            <!-- [[item.desc]] -->
          </paper-item>
        </template>
      </div>
      <div class="vertical">
        <template
          is="dom-repeat"
          items="{{elementProperties.String}}"
          filter="[[filterFn]]"
        >
          <paper-item>
          <paper-input label="[[item.name]]" value="{{item.value}}"></paper-input>
          <paper-tooltip>[[item.desc]]</paper-tooltip>
        </paper-item>
          <!-- [[item.desc]] -->
        </template>
      </div>
  </div>
  </template>

  <script>
    Polymer({

      is: 'paper-sandbox',

      properties: {
        showPrivate: {
          type: Boolean,
          value: false
        },
        filterFn: {
          type: Function,
          computed: '_computeFilterFn(showPrivate)'
        },
        importPath: {
          type: String
        },
        element: {
          type: Object
        },
        _hydroDesc: {
          type: Object,
          value: () => ({})
        },
        elementProperties: {
          type: Object,
          value: () => ({
            'Boolean': [],
            'String': [],
            'Function': [],
            'Object': [],
            'Number': []
          })
        },
        ignoredFunctions: {
          type: Array,
          value: () => ['attached', 'registered', 'ready' ,'detached']
        }
      },

      observers: [
        '_elementPropertiesChanged(elementProperties.*, element)',
        '_hydroDescChanged(_hydroDesc)',
        '_elementChanged(element)',
      ],

      _computeFilterFn(showPrivate) {
        return item => showPrivate || !item.private;
      },

      _handleFunctionButtonTap(e) {
        let model = e.model;
        model.set('item.lastResponse', this.element[model.item.name]());
      },

      attached() {
        this._observer = Polymer.dom(this).observeNodes(this._onNodesChange);
      },

      _onNodesChange: function(info) {
        this.element = Polymer.dom(this).children[0];
      },

      _elementChanged(element) {
        this.$.analyzer.src = `${this.element.importPath}${this.element.is}.html`;
        this.$.analyzer.analyze();
      },

      _elementPropertiesChanged(cr, element) {
        var nameSubpath = cr.path.indexOf('.value');
        if (nameSubpath >= 0) {
          let type = cr.path.split('.')[1];
          var itempath = cr.path.substring(0, nameSubpath);
          var item = this.get(itempath);
          var index = cr.base[type].indexOf(item);
          this.serializeValueToAttribute(item.value, item.name, element);
        }
      },

      _hydroDescChanged(_hydroDesc) {
        if (!_hydroDesc.elementsByTagName) {
          return;
        }
        let elementsDescriptor = _hydroDesc.elementsByTagName;
        // name = elementsDescriptor[this.element.is];

        let elementDescriptor = elementsDescriptor[this.element.is];
        // let element = document.createElement(name);
        let elementProperties = {
          'Boolean': [],
          'String': [],
          'Function': [],
          'Object': [],
          'Number': []
        };
        for (let property of elementDescriptor.properties) {
          let name = property.name;
          let firstChar = name[0];
          let isPrivate = firstChar == '_';
          let type = property.type;
            // TODO: manage unknown type properties whe type == ''
            // TODO: manage private properties
          if (type && !(type === 'Function' && this.ignoredFunctions.includes(name))) {
            let prop = {
              name,
              value: this.element[name],
              private: isPrivate,
              desc: property.desc,
            }
            if (type === 'Function') {
              prop.params = property.params;
              prop.lastResponse = undefined;
            }
            let lastIndex = elementProperties[type].push(prop) - 1;
            // TODO: type Function should listen to event, unless there are defined as properties
            // Maybe there's a way to user linkPaths method for that job ?
            this.element.addEventListener(`${name}-changed`, ev => {
              this.set(`elementProperties.${property.type}.${lastIndex}.value`, ev.detail.value);
            });
          }
        }
        this.elementProperties = elementProperties;
        // Polymer.dom(this.$.elements).appendChild(element);
        // this.element = element;
      }

    });
  </script>
</dom-module>
