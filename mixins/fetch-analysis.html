<script>
(()=> {
  'use strict';

  if (!window.Zecat) window.Zecat = {};
  
  /**
   * 
   * 
   * @polymer
   * @mixinFunction
   */
  Zecat.FetchAnalysis = superClass => class extends superClass {

    static get properties() {
      return {
        fetchingAnalysis: {
          type: Boolean,
          value: false,
          readOnly: true,
          notify: true
        }
      };
    }

    static get observers() {
      return [
        '_disableSpyWhileAutoScrolling(autoScrolling)'
      ];
    }

    constructor() {
      super();
      this.analysisErrors = {
        0: 'No element specified to retrieve analysis',
        1: 'Can not fetch analysis for a non element node',
        2: 'Analysis fetch error',
        3: 'Analysis fetched a wrong status code',
        4: 'No elements array find in analysis file',
        5: 'No analysis configuration for the given tag name'
      };
    }

    twrowAnalysisError(code) {
      throw new Error({code, description: this.analysisErrors[code]});
    }

    async fetchAnalysisForElement(el, analysisPath) {
      if (!el) this.twrowAnalysisError(0);
      // TODO: The custom element check could be improved following this example:
      // https://developers.google.com/web/fundamentals/architecture/building-components/shadowdom#findall
      if (el.nodeType != Node.ELEMENT_NODE) this.twrowAnalysisError(1);
      
      if (!analysisPath) {
        analysisPath = `${el.importPath}analysis.json`;
      }

      let fetchAnalysis;

      try {
        this._setFetchingAnalysis(true);
        fetchAnalysis = await fetch(analysisPath);
        this._setFetchingAnalysis(false);
      } catch (err) {
        this._setFetchingAnalysis(false);
        this.twrowAnalysisError(2);
      }

      if (!fetchAnalysis.ok) this.twrowAnalysisError(3);

      const {elements} = await fetchAnalysis.json();
      if (!elements || !(elements instanceof Array)) this.twrowAnalysisError(4);

      const tagName = el.nodeName.toLowerCase();
      const configForEl = elements.find(elConfig => elConfig.tagname === tagName);

      if (!configForEl) this.twrowAnalysisError(5);

      return configForEl;
    }
    
  };
})();
</script>