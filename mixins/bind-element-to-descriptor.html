<script>
  
(()=> {
  'use strict';

  if (!window.Zecat) window.Zecat = {};

  /**
   * 
   * 
   * @polymer
   * @mixinFunction
   */
  Zecat.BindElementToDescriptor = (superClass) => class extends superClass {

    static get properties() {
      return {
        descriptor: {
          type: Object,
          value: () => ({})
        },
        /**
         * @type {HTMLElement}
         */
        analyzedElement: {
          type: Object,
          notify: true
        }
      };
    }

    static get observers() {
      return [
        '_updateElementAttribute(descriptor.properties.*, analyzedElement)',
        '_bindElementAttributesToDescriptor(descriptor.properties, analyzedElement)'
      ];
    }

    constructor() {
      super();
      this._attributeChanged_boundListeners = {};
    }

    connectedCallback() {
      super.connectedCallback();
    }

    disconnectedCallback() {
      super.disconnectedCallback();
    }

    _updateDescriptorProperty(type, index, value) {
      this.set(`descriptor.properties.${type}.${index}.value`, value);
    }

    _bindElementAttributesToDescriptor(descriptorProperties, analyzedElement) {
      if (!descriptorProperties || !analyzedElement) return;

      for (let [type, typedProperties] of Object.entries(descriptorProperties)) {
        typedProperties.forEach(({name, notify = false}, i) => {
          // Copy the the initial value into the descriptor
          this._updateDescriptorProperty(type, i, analyzedElement[name]);

          if (!notify) return;
          
          const hyphenatedName = name.replace( /([A-Z])/g, "-$1" ).toLowerCase();
          const callback = e => {
            this._updateDescriptorProperty(type, i, e.detail.value);
          };
          // Keep a reference to the callback for future event listener removal
          this._attributeChanged_boundListeners[name] = callback;
          analyzedElement.addEventListener(`${hyphenatedName}-changed`, callback);
        });
      }
    }

    _updateElementAttribute(cr, element) {
      const nameSubpath = cr.path.indexOf('.value');
      if (nameSubpath >= 0) {
        // const type = cr.path.split('.')[2];
        const itempath = cr.path.substring(0, nameSubpath);
        const item = this.get(itempath);
        // const index = cr.base[type].indexOf(item);
        element[item.name] = item.value;
      }
    }

  };
})();
  

</script>